random()*colors.length)];
}

function resetShooter(){
  shooter = {
    x: canvas.width/2,
    y: canvas.height-35,
    color: nextColor,
    dx:0, dy:0,
    shooting:false
  };
  nextColor = rand();
}

// initial bubbles
for(let r=0;r<6;r++)
 for(let c=0;c<10;c++)
  bubbles.push({x:c*30+30,y:r*30+30,color:rand()});

resetShooter();

// aim events
canvas.addEventListener("mousemove",e=>{
  const r=canvas.getBoundingClientRect();
  aim={x:e.clientX-r.left,y:e.clientY-r.top};
});
canvas.addEventListener("touchmove",e=>{
  const r=canvas.getBoundingClientRect();
  aim={x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
});

canvas.addEventListener("click",shoot);
canvas.addEventListener("touchend",shoot);

function shoot(){
  if(shooter.shooting || !aim) return;
  const a=Math.atan2(aim.y-shooter.y, aim.x-shooter.x);
  shooter.dx=Math.cos(a)*6;
  shooter.dy=Math.sin(a)*6;
  shooter.shooting=true;
}

function drawBubble(b){
  ctx.beginPath();
  ctx.arc(b.x,b.y,R,0,Math.PI*2);
  ctx.fillStyle=b.color;
  ctx.fill();
}

function drawAim(){
  if(!aim || shooter.shooting) return;
  ctx.setLineDash([5,5]);
  ctx.beginPath();
  ctx.moveTo(shooter.x,shooter.y);
  ctx.lineTo(aim.x,aim.y);
  ctx.strokeStyle="white";
  ctx.stroke();
  ctx.setLineDash([]);
}

// connected same color
function connected(start){
  let stack=[start], group=[start];
  for(let i=0;i<stack.length;i++){
    for(let b of bubbles){
      if(
        b.color===start.color &&
        !group.includes(b) &&
        Math.hypot(b.x-stack[i].x,b.y-stack[i].y) < R*2.2
      ){
        group.push(b);
        stack.push(b);
      }
    }
  }
  return group;
}

function attach(){
  const nb={x:shooter.x,y:shooter.y,color:shooter.color};
  bubbles.push(nb);

  const g = connected(nb);
  if(g.length >= 3){
    popped += g.length;                 // ✅ COUNT बढ़ेगा
    counter.innerText = "Bubble fode: " + popped;
    bubbles = bubbles.filter(b=>!g.includes(b));
  }
  resetShooter();
}

function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  bubbles.forEach(drawBubble);
  drawBubble(shooter);

  // NEXT bubble (clear bottom-right)
  drawBubble({x:canvas.width-30,y:canvas.height-30,color:nextColor});

  drawAim();

  if(shooter.shooting){
    shooter.x+=shooter.dx;
    shooter.y+=shooter.dy;

    if(shooter.x<R || shooter.x>canvas.width-R) shooter.dx*=-1;

    let hit=false;
    for(let b of bubbles){
      if(Math.hypot(b.x-shooter.x,b.y-shooter.y)<R*2){
        hit=true; attach(); break;
      }
    }
    if(shooter.y<R && !hit) attach();
  }

  requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
